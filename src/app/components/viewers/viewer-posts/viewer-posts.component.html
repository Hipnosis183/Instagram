<create-collection *ngIf="collectionCreate" [fromPost]="feedPost.id"
  (onCreate)="collectionCreated()" (onClose)="collectionCreateOpen()"></create-collection>
<div autoFocus tabindex="0" class="viewer-container">
  <div class="viewer-overlay"></div>
  <div class="viewer-contents">
    <div class="viewer-sidenav">
      <div class="sidenav-user">
        <img [dropdown]="moreOptions" tooltip="More Options" src="/assets/images/more.svg" class="more-button">
        <div #moreOptions>
          <span (click)="downloadMedia()">
            <p>Download</p>
            <img src="/assets/images/download.svg" class="ml-3 w-[18px]">
          </span>
        </div>
        <img-await [source]="feedPost.user.profile_pic_url" class="sidenav-image"></img-await>
        <div [routerLink]="['/' + feedPost.user.username]" class="sidenav-header">
          <div class="sidenav-name">
            <div class="text-main">{{ feedPost.user.full_name ? feedPost.user.full_name : feedPost.user.username }}
            </div>
            <img *ngIf="feedPost.user.is_verified" src="/assets/images/verified.svg">
          </div>
          <div class="text-sub">@{{ feedPost.user.username }}</div>
        </div>
        <div *ngIf="feedPost.location" class="sidenav-location">{{ feedPost.location.name }}</div>
        <div class="sidenav-stats">
          <div class="text-sub">{{ feedPost.taken_at * 1000 | date }}</div>
          <div class="flex">
            <div class="mr-4 text-main">{{ feedPost.like_count | shortNumber }}</div>
            <img [src]="'/assets/images/' + (feedPost.has_liked ? 'like-fill.svg' : 'like.svg')"
              (click)="feedPost.has_liked ? unlikeSend.emit(feedPost.id) : likeSend.emit(feedPost.id)"
              class="cursor-pointer mr-4 object-contain">
            <img [src]="'/assets/images/' + (feedPost.has_viewer_saved ? 'save-fill.svg' : 'save.svg')"
              (click)="feedPost.has_viewer_saved ? unsaveSend.emit({ media: feedPost.id }) : saveSend.emit({ media: feedPost.id })"
              [dropdown]="savePost" [dropdownHover]="true" class="cursor-pointer object-contain">
            <div #savePost>
              <span (click)="collectionCreateOpen()" class="create-button">&nbsp;+&ensp;NEW COLLECTION&nbsp;</span>
              <div *ngFor="let collection of store.state.savedPosts">
                <span *ngIf="collection.collection_id != 'ALL_MEDIA_AUTO_COLLECTION'" (click)="saveMedia(feedPost, collection)" class="viewer-saved">
                  <img-await *ngIf="collection.cover_media_list" [source]="collection.cover_media_list[0].image_versions2.candidates[1].url"></img-await>
                  <p [class]="feedPost.saved_collection_ids ? feedPost.saved_collection_ids.includes(collection.collection_id) ? 'font-bold' : '' : ''">{{ collection.collection_name }}</p>
                </span>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="feedPost.caption" [innerHTML]="feedPost.caption.text | parseUrls " class="text-main w-full"></div>
      </div>
    </div>
    <img-await *ngIf="feedPost.instagular.media_type[carouselIndex] == 1" class="viewer-media"
      [source]="feedPost.instagular.full[carouselIndex]">
    </img-await>
    <div *ngIf="feedPost.instagular.media_type[carouselIndex] == 2 || feedPost.instagular.media_type[carouselIndex] == 3" class="viewer-media">
      <div *ngIf="feedPost.video_duration < 60; then play; else block"></div>
      <ng-template #play>
        <video autoplay controls loop [muted]="true" [src]="feedPost.instagular.full[carouselIndex] | encode:true | async"></video>
      </ng-template>
      <ng-template #block>
        <div class="viewer-text">
          <p>
            This video is longer than a minute, and it's not suitable to be converted and displayed by the app.
            You can still open the original video in a new tab and watch it externally.
          </p>
          <button (click)="openMedia()">WATCH IN NEW TAB</button>
        </div>
        <img-await [source]="feedPost.instagular.thumb[0]" class="viewer-image"></img-await>
      </ng-template>
    </div>
    <div class="prev-button">
      <div *ngIf="feedPost.instagular.full.length > 1 && carouselIndex > 0" class="carousel">
        <img src="/assets/images/chevron-left.svg" (click)="carouselPrev()">
      </div>
      <img *ngIf="feedIndex.current > 0" (click)="postPrev()" src="/assets/images/chevron-d-left.svg">
    </div>
    <div class="next-button">
      <div *ngIf="feedPost.instagular.full.length > 1 && carouselIndex < feedPost.instagular.full.length - 1" class="carousel">
        <img src="/assets/images/chevron-right.svg" (click)="carouselNext()">
      </div>
      <img *ngIf="feedIndex.current < feedIndex.total" (click)="postNext()" src="/assets/images/chevron-d-right.svg">
    </div>
    <div (click)="closeSend.emit()" class="close-button">
      <img src="/assets/images/close.svg">
    </div>
    <div *ngIf="feedPost.instagular.full.length > 1" class="viewer-count">
      <div *ngFor="let media of feedPost.instagular.full; index as i">
        <div class="count-dot" [class]="i == carouselIndex ? 'bg-blue-500' : 'bg-slate-100'"></div>
      </div>
    </div>
  </div>
</div>